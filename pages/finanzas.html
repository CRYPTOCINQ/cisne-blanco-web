<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cisne Blanco ‚Äî Finanzas</title>
  <link rel="icon" href="../assets/favicon.ico" />
  <link rel="stylesheet" href="../assets/css/main.css?v=1401.1" />
</head>

<body class="transition-theme">

<!-- ========= Topbar (id√©ntico a Calendario, pesta√±a activa en Finanzas) ========= -->
<header class="topbar">
  <div class="topbar-inner">
    <a href="../index.html" class="brand">
      <span class="brand-dot">CB</span>
      <span class="brand-title">Cisne Blanco ‚Äî Maqueta Base</span>
    </a>

    <nav class="tabs">
      <a href="../index.html">Inicio</a>
      <a href="./calendario.html">Calendario</a>
      <a href="./habitos.html">H√°bitos</a>
      <a href="./salud.html">Salud</a>
      <a href="./familia.html">Familia</a>
      <a href="./social.html">Social</a>
      <a class="active" href="./finanzas.html">Finanzas</a>
    </nav>

    <button id="themeToggle" class="theme-pill">
      Tema: <span id="themeLabel">auto</span>
    </button>
  </div>
</header>

<main style="max-width:1100px;margin:1.25rem auto;padding:0 1rem;">

  <!-- ========= Panel superior: totales din√°micos ========= -->
  <section class="surface" style="padding:1rem;">
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;">
      <div class="card p-3" id="cardSaldo">
        <div class="muted text-sm">üí∞ Saldo total</div>
        <div id="saldoTotal" style="font-size:1.75rem;font-weight:700;margin-top:.25rem;">0</div>
      </div>
      <div class="card p-3">
        <div class="muted text-sm">üü¢ Ingresos</div>
        <div id="totalIngresos" style="font-size:1.5rem;font-weight:700;margin-top:.25rem;">0</div>
      </div>
      <div class="card p-3">
        <div class="muted text-sm">üî¥ Egresos</div>
        <div id="totalEgresos" style="font-size:1.5rem;font-weight:700;margin-top:.25rem;">0</div>
      </div>
    </div>

    <!-- Controles -->
    <div style="display:flex;gap:.5rem;align-items:center;justify-content:space-between;margin-top:.75rem;">
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
        <button id="btnAdd" class="btn btn-primary">+ Movimiento</button>
        <button id="btnExport" class="btn">Exportar (Excel / PDF)</button>
      </div>

      <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
        <select id="filtroCategoria" class="input" style="min-width:160px;padding:.4rem .5rem;border:1px solid var(--card-border);border-radius:10px;background:var(--card);color:var(--fg);">
          <option value="">Todas las categor√≠as</option>
          <option>Forex</option>
          <option>Acciones</option>
          <option>√çndices</option>
          <option>Futuros</option>
          <option>Crypto</option>
          <option>Otros</option>
        </select>
        <input id="filtroDesde" type="date" class="input" style="padding:.4rem .5rem;border:1px solid var(--card-border);border-radius:10px;background:var(--card);color:var(--fg);" />
        <input id="filtroHasta" type="date" class="input" style="padding:.4rem .5rem;border:1px solid var(--card-border);border-radius:10px;background:var(--card);color:var(--fg);" />
        <button id="btnLimpiarFiltros" class="btn btn-sm">Limpiar</button>
      </div>
    </div>
  </section>

  <!-- ========= Lista de movimientos ========= -->
  <section style="margin-top:1rem;">
    <h2 style="margin:.25rem 0 0 0;">Movimientos</h2>
    <div id="listaMovimientos" class="surface" style="margin-top:.5rem;padding:1rem;"></div>
  </section>

  <!-- ========= Gr√°ficos: tabs (Torta / Barras) ========= -->
  <section style="margin-top:1rem;">
    <div class="card" style="padding:1rem;">
      <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
        <button id="tabTorta" class="btn btn-sm btn--primary">Torta por categor√≠a</button>
        <button id="tabBarras" class="btn btn-sm">Barras por fecha</button>
      </div>

      <div style="margin-top:1rem;">
        <canvas id="chartTorta" height="140"></canvas>
        <canvas id="chartBarras" height="140" style="display:none;"></canvas>
      </div>
    </div>
  </section>
</main>

<!-- ========= Toggle de tema (id√©ntico a Calendario; usa 'navy-ice') ========= -->
<script>
(function(){
  const root=document.documentElement;
  const KEY="theme";
  const btn=document.getElementById('themeToggle');
  const lab=document.getElementById('themeLabel');
  function apply(val){
    if(val==='navy-ice') root.setAttribute('data-theme','navy-ice');
    else root.removeAttribute('data-theme');
    if(lab) lab.textContent=(val||'auto');
  }
  const saved=localStorage.getItem(KEY)||'auto';
  apply(saved);
  if(btn) btn.onclick=()=>{
    const next=(localStorage.getItem(KEY)==='navy-ice')?'auto':'navy-ice';
    localStorage.setItem(KEY,next); apply(next);
  };
})();
</script>

<!-- ========= Finanzas v2.0-alpha ========= -->
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  // ===== Namespace y helpers =====
  const DB_KEY = 'cb_finanzas_v1';

  const $ = (id) => document.getElementById(id);
  const pad = (n) => String(n).padStart(2,'0');
  const toISO = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  const load = () => {
    try { return JSON.parse(localStorage.getItem(DB_KEY) || '[]'); }
    catch { return []; }
  };
  const save = (arr) => localStorage.setItem(DB_KEY, JSON.stringify(arr));

  // ===== Estado =====
  let data = load();               // [{id, date, type: 'ingreso'|'egreso', amount:number, category, note}]
  let filtros = { categoria:'', desde:'', hasta:'' };

  // ===== Referencias UI =====
  const saldoTotalEl   = $('saldoTotal');
  const totalIngEl     = $('totalIngresos');
  const totalEgrEl     = $('totalEgresos');
  const listaEl        = $('listaMovimientos');

  const filtroCatEl    = $('filtroCategoria');
  const filtroDesdeEl  = $('filtroDesde');
  const filtroHastaEl  = $('filtroHasta');

  const tabTortaEl     = $('tabTorta');
  const tabBarrasEl    = $('tabBarras');
  const chartTortaEl   = $('chartTorta');
  const chartBarrasEl  = $('chartBarras');

  const btnAdd         = $('btnAdd');
  const btnExport      = $('btnExport');

  // ===== Modal (cuidado especial de estabilidad) =====
  const modal = document.createElement('dialog');
  modal.id = 'modalFin';
  modal.className = 'card';
  modal.style.padding = '0';
  modal.innerHTML = `
    <form method="dialog" style="padding:1rem 1rem 0 1rem;">
      <h3 id="modalTitle" style="margin:0 0 .75rem 0;">Nuevo movimiento</h3>
      <div class="modal-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;">
        <div>
          <label class="muted" for="inpDate">Fecha</label>
          <input id="inpDate" type="date" class="input" required>
        </div>
        <div>
          <label class="muted" for="inpType">Tipo</label>
          <select id="inpType" class="input" required>
            <option value="ingreso">Ingreso</option>
            <option value="egreso">Egreso</option>
          </select>
        </div>
        <div>
          <label class="muted" for="inpAmount">Monto</label>
          <input id="inpAmount" type="number" step="0.01" min="0" class="input" placeholder="0.00" required>
        </div>
        <div>
          <label class="muted" for="inpCategory">Categor√≠a</label>
          <select id="inpCategory" class="input">
            <option value="">Sin categor√≠a</option>
            <option>Forex</option>
            <option>Acciones</option>
            <option>√çndices</option>
            <option>Futuros</option>
            <option>Crypto</option>
            <option>Otros</option>
          </select>
        </div>
        <div style="grid-column:1/-1;">
          <label class="muted" for="inpNote">Nota</label>
          <textarea id="inpNote" rows="3" class="input" placeholder="Detalle o referencia"></textarea>
        </div>
      </div>
      <div class="modal-actions" style="display:flex;gap:.5rem;justify-content:flex-end;padding:1rem 0;">
        <button id="btnSave" class="btn btn-primary">Guardar</button>
        <button value="cancel" class="btn">Cerrar</button>
      </div>
    </form>`;
  document.body.appendChild(modal);

  // Para edici√≥n puntual
  let editingId = null;

  // ===== Render totales =====
  function renderTotales(list){
    const ingresos = list.filter(x=>x.type==='ingreso').reduce((a,b)=>a+Number(b.amount||0),0);
    const egresos  = list.filter(x=>x.type==='egreso').reduce((a,b)=>a+Number(b.amount||0),0);
    const saldo    = ingresos - egresos;

    totalIngEl.textContent = formato(ingresos);
    totalEgrEl.textContent = formato(egresos);
    saldoTotalEl.textContent= formato(saldo);

    // Estilo visual del saldo (verde/rojo)
    const card = $('cardSaldo');
    if(card){
      card.style.borderColor = saldo>=0 ? 'var(--ok)' : 'var(--danger)';
      card.style.boxShadow = 'var(--shadow)';
    }
  }

  // ===== Render lista =====
  function renderLista(list){
    if(!list.length){
      listaEl.innerHTML = '<div class="muted">No hay movimientos registrados.</div>';
      return;
    }
    listaEl.innerHTML = '';
    list.forEach(item=>{
      const row = document.createElement('div');
      row.className = 'card p-3 flex items-start justify-between';
      row.innerHTML = `
        <div>
          <div class="text-sm font-semibold">${item.type==='ingreso'?'üü¢ Ingreso':'üî¥ Egreso'} ‚Äî ${formato(item.amount)}</div>
          <div class="text-xs muted">${item.date}${item.category?` ‚Ä¢ ${item.category}`:''}</div>
          ${item.note?`<div class="mt-1 text-xs muted">${escapeHtml(item.note)}</div>`:''}
        </div>
        <div class="action-row flex gap-2">
          <button class="btn btn-sm" data-action="edit">Editar</button>
          <button class="btn btn-sm" data-action="delete">Borrar</button>
        </div>`;
      row.querySelector('[data-action="edit"]').onclick=()=>abrirModalEdicion(item.id);
      row.querySelector('[data-action="delete"]').onclick=()=>eliminar(item.id);
      listaEl.appendChild(row);
    });
  }

  // ===== Filtros =====
  function aplicarFiltros(){
    return data.filter(x=>{
      if(filtros.categoria && x.category!==filtros.categoria) return false;
      if(filtros.desde && x.date < filtros.desde) return false;
      if(filtros.hasta && x.date > filtros.hasta) return false;
      return true;
    });
  }

  // ===== Gr√°ficos =====
  let chartPie = null;
  let chartBar = null;

  function renderCharts(list){
    // Limpia instancias previas
    if(chartPie){ chartPie.destroy(); chartPie=null; }
    if(chartBar){ chartBar.destroy(); chartBar=null; }

    // --- Torta por categor√≠a (suma absoluta por categor√≠a, ingresos como +, egresos como + para ver pesos)
    const mapCat = {};
    list.forEach(x=>{
      const key = x.category || 'Sin categor√≠a';
      const valAbs = Math.abs(Number(x.amount)||0);
      mapCat[key] = (mapCat[key]||0) + valAbs;
    });
    const labelsPie = Object.keys(mapCat);
    const dataPie = Object.values(mapCat);

    chartPie = new Chart(chartTortaEl.getContext('2d'), {
      type: 'pie',
      data: { labels: labelsPie, datasets: [{ data: dataPie }] },
      options: {
        plugins: { legend: { position:'bottom' } }
      }
    });

    // --- Barras por fecha (saldo neto por d√≠a)
    const mapFecha = {};
    list.forEach(x=>{
      const s = Number(x.amount)||0;
      const net = x.type==='ingreso' ? s : -s;
      mapFecha[x.date] = (mapFecha[x.date]||0) + net;
    });
    const fechas = Object.keys(mapFecha).sort();
    const netos  = fechas.map(f=>mapFecha[f]);

    chartBar = new Chart(chartBarrasEl.getContext('2d'), {
      type: 'bar',
      data: { labels: fechas, datasets: [{ label: 'Neto diario', data: netos }] },
      options: {
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display:false } }
      }
    });
  }

  // Tabs gr√°ficos
  tabTortaEl.onclick = ()=>{
    tabTortaEl.classList.add('btn--primary');
    tabBarrasEl.classList.remove('btn--primary');
    chartTortaEl.style.display = '';
    chartBarrasEl.style.display = 'none';
  };
  tabBarrasEl.onclick = ()=>{
    tabBarrasEl.classList.add('btn--primary');
    tabTortaEl.classList.remove('btn--primary');
    chartTortaEl.style.display = 'none';
    chartBarrasEl.style.display = '';
  };

  // ===== CRUD =====
  function nuevoId(){ return Math.random().toString(36).slice(2,10); }

  function abrirModalAlta(){
    editingId = null;
    $('modalTitle').textContent = 'Nuevo movimiento';
    $('inpDate').value = toISO(new Date());
    $('inpType').value = 'ingreso';
    $('inpAmount').value = '';
    $('inpCategory').value = '';
    $('inpNote').value = '';
    modal.showModal();
  }

  function abrirModalEdicion(id){
    const it = data.find(x=>x.id===id);
    if(!it) return;
    editingId = id;
    $('modalTitle').textContent = 'Editar movimiento';
    $('inpDate').value = it.date;
    $('inpType').value = it.type;
    $('inpAmount').value = it.amount;
    $('inpCategory').value = it.category || '';
    $('inpNote').value = it.note || '';
    modal.showModal();
  }

  function guardar(ev){
    ev.preventDefault();
    const date = $('inpDate').value;
    const type = $('inpType').value;
    const amount = parseFloat($('inpAmount').value);
    const category = $('inpCategory').value;
    const note = $('inpNote').value.trim();

    if(!date || !type || !isFinite(amount)){
      alert('Complet√° fecha, tipo y monto v√°lido.');
      return;
    }

    if(editingId){
      const idx = data.findIndex(x=>x.id===editingId);
      if(idx>-1) data[idx] = { ...data[idx], date, type, amount, category, note };
      editingId = null;
    } else {
      data.push({ id:nuevoId(), date, type, amount, category, note });
    }
    save(data);
    modal.close();
    refresh(); // actualizaci√≥n en tiempo real
  }

  function eliminar(id){
    if(!confirm('¬øBorrar este movimiento?')) return;
    data = data.filter(x=>x.id!==id);
    save(data);
    refresh();
  }

  // ===== Exportar =====
  async function exportar(){
    if(!data.length){ alert('No hay movimientos para exportar.'); return; }

    const rows = [["Fecha","Tipo","Monto","Categor√≠a","Nota"]];
    aplicarFiltros().forEach(x=>{
      rows.push([x.date, x.type, String(x.amount), x.category||"-", x.note||"-"]);
    });

    const formato = prompt('Ingres√° el formato a exportar: xlsx o pdf','xlsx');
    if(!formato) return;

    if(formato.toLowerCase()==='xlsx'){
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, 'Finanzas');
      XLSX.writeFile(wb, 'CisneBlanco_Finanzas.xlsx');
    } else if(formato.toLowerCase()==='pdf'){
      const doc = new jspdf.jsPDF();
      doc.setFontSize(14);
      doc.text('Cisne Blanco ‚Äî Finanzas', 14, 16);
      doc.setFontSize(10);

      let y = 26;
      rows.forEach((r,i)=>{
        const line = r.map(c=>String(c)).join(' | ');
        doc.text(line, 14, y);
        y += 6;
        if(y > 280){ doc.addPage(); y = 20; }
      });

      doc.save('CisneBlanco_Finanzas.pdf');
    } else {
      alert('Formato no reconocido. Us√° xlsx o pdf.');
    }
  }

  // ===== Util =====
  function formato(n){
    try{
      return new Intl.NumberFormat('es-AR',{ style:'currency', currency:'ARS', maximumFractionDigits:2 }).format(n);
    }catch{
      return (Math.round(n*100)/100).toString();
    }
  }
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  // ===== Refresh general (lista, totales, charts) =====
  function refresh(){
    const filtrada = aplicarFiltros();
    renderTotales(filtrada);
    renderLista(filtrada);
    renderCharts(filtrada);
  }

  // ===== Listeners =====
  $('btnSave').onclick = guardar;
  btnAdd.onclick = abrirModalAlta;
  btnExport.onclick = exportar;

  filtroCatEl.onchange = ()=>{ filtros.categoria = filtroCatEl.value; refresh(); };
  filtroDesdeEl.onchange = ()=>{ filtros.desde = filtroDesdeEl.value; refresh(); };
  filtroHastaEl.onchange = ()=>{ filtros.hasta = filtroHastaEl.value; refresh(); };
  $('btnLimpiarFiltros').onclick = ()=>{
    filtros = { categoria:'', desde:'', hasta:'' };
    filtroCatEl.value=''; filtroDesdeEl.value=''; filtroHastaEl.value='';
    refresh();
  };

  // ===== Primer render =====
  refresh();
});
</script>

<!-- Librer√≠as externas (mismas que Calendario + Chart.js + jsPDF) -->
<script src="../assets/js/theme.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jjspdf.umd.min.js"></script>

</body>
</html>
