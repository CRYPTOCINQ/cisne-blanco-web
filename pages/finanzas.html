<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cisne Blanco ‚Äî Finanzas</title>
  <link rel="icon" href="../assets/favicon.ico" />
  <link rel="stylesheet" href="../assets/css/main.css?v=1401.1" />
</head>

<body class="transition-theme">


<!-- ========= Topbar ========= -->
<header class="topbar">
  <div class="topbar-inner">
    <a href="../index.html" class="brand">
      <span class="brand-dot">CB</span>
      <span class="brand-title">Cisne Blanco ‚Äî Maqueta Base</span>
    </a>

    <nav class="tabs">
      <a href="../index.html">Inicio</a>
      <a href="./calendario.html">Calendario</a>
      <a href="./habitos.html">H√°bitos</a>
      <a href="./salud.html">Salud</a>
      <a href="./familia.html">Familia</a>
      <a href="./social.html">Social</a>
      <a class="active" href="./finanzas.html">Finanzas</a>
    </nav>

    <button id="themeToggle" class="theme-pill">
      Tema: <span id="themeLabel">auto</span>
    </button>
  </div>
</header>


<main style="max-width:1100px;margin:1.25rem auto;padding:0 1rem;">


  <!-- ========= Panel superior: totales ========= -->
  <section class="surface" style="padding:1rem;">
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;">
      <div class="card p-3" id="cardSaldo">
        <div class="muted text-sm">üí∞ Saldo total</div>
        <div id="saldoTotal" style="font-size:1.75rem;font-weight:700;margin-top:.25rem;">0</div>
      </div>
      <div class="card p-3">
        <div class="muted text-sm">üü¢ Ingresos</div>
        <div id="totalIngresos" style="font-size:1.5rem;font-weight:700;margin-top:.25rem;">0</div>
      </div>
      <div class="card p-3">
        <div class="muted text-sm">üî¥ Egresos</div>
        <div id="totalEgresos" style="font-size:1.5rem;font-weight:700;margin-top:.25rem;">0</div>
      </div>
    </div>

    <!-- Controles -->
    <div style="display:flex;gap:.5rem;align-items:center;justify-content:space-between;margin-top:.75rem;">
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
        <button id="btnAdd" class="btn btn-primary">+ Movimiento</button>
        <button id="btnAddTrade" class="btn btn-sm btn-primary">+ Trade</button>
        <button id="btnExport" class="btn">Exportar (Excel / PDF)</button>
      </div>

      <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
        <select id="filtroCategoria" class="input" style="min-width:160px;">
          <option value="">Todas las categor√≠as</option>
          <option>Forex</option>
          <option>Acciones</option>
          <option>√çndices</option>
          <option>Futuros</option>
          <option>Crypto</option>
          <option>Otros</option>
        </select>
        <input id="filtroDesde" type="date" class="input" />
        <input id="filtroHasta" type="date" class="input" />
        <button id="btnLimpiarFiltros" class="btn btn-sm">Limpiar</button>
      </div>
    </div>
  </section>


  <!-- ========= Lista Movimientos ========= -->
  <section style="margin-top:1rem;">
    <h2 style="margin:0;">Movimientos</h2>
    <div id="listaMovimientos" class="surface" style="margin-top:.5rem;padding:1rem;"></div>
  </section>


  <!-- ========= Gr√°ficos ========= -->
  <section style="margin-top:1rem;">
    <div class="card" style="padding:1rem; display:flex; flex-direction:column; gap:1rem;">

      <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;">
        <button id="tabTorta" class="btn btn-sm btn--primary">Torta por categor√≠a</button>
        <button id="tabBarras" class="btn btn-sm">Barras por fecha</button>

        <select id="modoGrafico" class="input" style="max-width:130px; margin-left:auto;">
          <option value="dia">D√≠a</option>
          <option value="semana">Semana</option>
          <option value="mes">Mes</option>
        </select>
      </div>

      <div style="display:flex; gap:1rem; align-items:flex-start; justify-content:space-between;">
          <canvas id="chartTorta" style="max-height:240px; flex:1;"></canvas>
          <canvas id="chartBarras" style="max-height:240px; flex:1; display:none;"></canvas>
      </div>

    </div>
  </section>


<!-- ===========================================================
     MODAL TRADING
=========================================================== -->
<dialog id="modalTrade" class="card" style="padding:0;">
  <form method="dialog" style="padding:1rem 1rem 0 1rem;">
    <h3 style="margin:0 0 .75rem 0;">Nueva operaci√≥n</h3>

    <div class="modal-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;">

      <div>
        <label class="muted">Fecha</label>
        <input id="tradeDate" type="date" class="input">
      </div>

      <div>
        <label class="muted">Hora</label>
        <input id="tradeTime" type="time" class="input">
      </div>

      <div>
        <label class="muted">Ticker</label>
        <input id="tradeTicker" type="text" class="input" placeholder="EURUSD / AAPL / BTCUSDT">
      </div>

      <div>
        <label class="muted">Tipo</label>
        <select id="tradeType" class="input">
          <option value="buy">Buy</option>
          <option value="sell">Sell</option>
        </select>
      </div>

      <div>
        <label class="muted">Ticket</label>
        <input id="tradeTicket" type="number" class="input" placeholder="N¬∞">
      </div>

      <div>
        <label class="muted">Entry</label>
        <input id="tradeEntry" type="number" class="input" step="0.0001">
      </div>

      <div>
        <label class="muted">SL</label>
        <input id="tradeSL" type="number" class="input" step="0.0001">
      </div>

      <div>
        <label class="muted">TP</label>
        <input id="tradeTP" type="number" class="input" step="0.0001">
      </div>

      <div>
        <label class="muted">Profit</label>
        <input id="tradeProfit" type="number" class="input" step="0.01" placeholder="0.00">
      </div>

    </div>

    <div class="modal-actions" style="display:flex;gap:.5rem;justify-content:flex-end;padding:1rem 0;">
      <button id="btnSaveTrade" class="btn btn-primary">Guardar</button>
      <button value="cancel" class="btn">Cerrar</button>
    </div>
  </form>
</dialog>



<!-- ===========================================================
     TOGGLE TEMA
=========================================================== -->
<script>
(function () {
  const root = document.documentElement;
  const KEY = 'theme';
  const btn = document.getElementById('themeToggle');
  const lab = document.getElementById('themeLabel');

  function apply(val) {
    if (val === 'navy-ice') {
      root.setAttribute('data-theme', 'navy-ice');
    } else {
      root.removeAttribute('data-theme');
    }
    lab.textContent = val || 'auto';
  }

  const saved = localStorage.getItem(KEY) || 'auto';
  apply(saved);

  btn.onclick = () => {
    const current = localStorage.getItem(KEY) || 'auto';
    const next = current === 'navy-ice' ? 'auto' : 'navy-ice';
    localStorage.setItem(KEY, next);
    apply(next);
  };
})();
</script>



<!-- ===========================================================
     JS PRINCIPAL FINANZAS (CORREGIDO)
=========================================================== -->
<script>
document.addEventListener('DOMContentLoaded', ()=>{

  const DB_KEY = 'cb_finanzas_v1';
  const $ = id => document.getElementById(id);

  const pad  = n => String(n).padStart(2,'0');
  const toISO = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  const load = ()=> JSON.parse(localStorage.getItem(DB_KEY) || "[]");
  const save = arr => localStorage.setItem(DB_KEY, JSON.stringify(arr));

  let data = load();
  let filtros = { categoria:'', desde:'', hasta:'' };

  const saldoTotalEl = $('saldoTotal');
  const totalIngEl   = $('totalIngresos');
  const totalEgrEl   = $('totalEgresos');
  const listaEl      = $('listaMovimientos');

  const filtroCatEl   = $('filtroCategoria');
  const filtroDesdeEl = $('filtroDesde');
  const filtroHastaEl = $('filtroHasta');

  const tabTortaEl   = $('tabTorta');
  const tabBarrasEl  = $('tabBarras');
  const chartTortaEl = $('chartTorta');
  const chartBarrasEl= $('chartBarras');

  const modoGraficoEl = $('modoGrafico');

  let chartPie = null;
  let chartBar = null;



  /* ==========================
        MODAL MOVIMIENTOS
  =========================== */
  const modal = document.createElement('dialog');
  modal.id = 'modalFin';
  modal.className = 'card';
  modal.style.padding = '0';
  modal.innerHTML = `
    <form method="dialog" style="padding:1rem 1rem 0 1rem;">
      <h3 id="modalTitle">Nuevo movimiento</h3>
      <div class="modal-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;">
        <div><label class="muted">Fecha</label><input id="inpDate" type="date" class="input"></div>
        <div><label class="muted">Tipo</label>
          <select id="inpType" class="input">
            <option value="ingreso">Ingreso</option>
            <option value="egreso">Egreso</option>
          </select>
        </div>
        <div><label class="muted">Monto</label><input id="inpAmount" type="number" step="0.01" class="input"></div>
        <div>
          <label class="muted">Categor√≠a</label>
          <select id="inpCategory" class="input">
            <option value="">Sin categor√≠a</option>
            <option>Forex</option>
            <option>Acciones</option>
            <option>√çndices</option>
            <option>Futuros</option>
            <option>Crypto</option>
            <option>Otros</option>
          </select>
        </div>
        <div style="grid-column:1/-1;">
          <label class="muted">Nota</label>
          <textarea id="inpNote" class="input"></textarea>
        </div>
      </div>
      <div class="modal-actions" style="display:flex;gap:.5rem;justify-content:flex-end;padding:1rem 0;">
        <button id="btnSave" class="btn btn-primary">Guardar</button>
        <button value="cancel" class="btn">Cerrar</button>
      </div>
    </form>`;
  document.body.appendChild(modal);

  let editingId = null;



  /* ==========================
        RENDER DE TOTALES
  =========================== */
  function renderTotales(list){
    const ingresos = list.filter(x=>x.type==='ingreso')
                         .reduce((a,b)=>a+Number(b.amount||0),0);
    const egresos  = list.filter(x=>x.type==='egreso')
                         .reduce((a,b)=>a+Number(b.amount||0),0);
    const saldo    = ingresos - egresos;

    totalIngEl.textContent   = formato(ingresos);
    totalEgrEl.textContent   = formato(egresos);
    saldoTotalEl.textContent = formato(saldo);
  }



  /* ==========================
        RENDER DE LISTA
  =========================== */
  function renderLista(list){
    if(!list.length){
      listaEl.innerHTML = '<div class="muted">No hay movimientos registrados.</div>';
      return;
    }
    listaEl.innerHTML = '';

    list.forEach(item=>{
      const row = document.createElement('div');
      row.className = 'card p-3 flex items-start justify-between';

      row.innerHTML = `
        <div>
          <div class="text-sm font-semibold">
            ${item.type==='ingreso'?'üü¢ Ingreso':'üî¥ Egreso'} ‚Äî ${formato(item.amount)}
          </div>
          <div class="text-xs muted">
            ${item.date}${item.category ? ` ‚Ä¢ ${item.category}` : ''}
          </div>
          ${item.note ? `<div class="mt-1 text-xs muted">${escapeHtml(item.note)}</div>` : ''}
        </div>

        <div class="action-row flex gap-2">
          <button class="btn btn-sm" data-action="edit">Editar</button>
          <button class="btn btn-sm" data-action="delete">Borrar</button>
        </div>
      `;

      row.querySelector('[data-action="edit"]').onclick = ()=>abrirModalEdicion(item.id);
      row.querySelector('[data-action="delete"]').onclick = ()=>eliminar(item.id);

      listaEl.appendChild(row);
    });
  }



  /* ==========================
        FILTROS
  =========================== */
  function aplicarFiltros(){
    return data.filter(x=>{

      if(filtros.categoria && x.category !== filtros.categoria)
        return false;

      if(filtros.desde && x.date < filtros.desde)
        return false;

      if(filtros.hasta && x.date > filtros.hasta)
        return false;

      return true;
    });
  }



  /* ==========================
        CHARTS
  =========================== */
  function renderCharts(list){
    if(chartPie){ chartPie.destroy(); chartPie = null; }
    if(chartBar){ chartBar.destroy(); chartBar = null; }

    /* ---- TORTA ---- */
    const mapCat = {};
    list.forEach(x=>{
      const key = x.category || 'Sin categor√≠a';
      mapCat[key] = (mapCat[key] || 0) + Math.abs(Number(x.amount)||0);
    });

    if(!mapCat["Trades"]) delete mapCat["Trades"];

    chartPie = new Chart(chartTortaEl, {
      type: 'pie',
      data: {
        labels: Object.keys(mapCat),
        datasets: [{
          data: Object.values(mapCat)
        }]
      },
      options: {
        plugins: { legend: { position:'right' } }
      }
    });

    /* ---- BARRAS ---- */
    const modo = modoGraficoEl.value || 'dia';
    const mapFecha = {};

    list.forEach(x=>{
      const d = x.date;
      let clave = d;

      if(modo === 'semana'){
        const dt = new Date(d);
        const first = new Date(dt.setDate(dt.getDate() - dt.getDay()));
        clave = first.toISOString().slice(0,10);
      }
      else if(modo === 'mes'){
        clave = d.slice(0,7);
      }

      if(!mapFecha[clave]) mapFecha[clave] = 0;

      const val = (x.type==='ingreso' ? +x.amount : -x.amount) || 0;
      mapFecha[clave] += val;
    });

    const labels = Object.keys(mapFecha).sort();

    chartBar = new Chart(chartBarrasEl, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: "Balance",
          data: labels.map(f => mapFecha[f])
        }]
      },
      options: {
        scales: { y:{ beginAtZero:true } }
      }
    });
  }



  /* ==========================
        MODAL MOVIMIENTOS
  =========================== */
  function abrirModalAlta(){
    editingId = null;
    $('modalTitle').textContent = 'Nuevo movimiento';
    $('inpDate').value = toISO(new Date());
    $('inpType').value = 'ingreso';
    $('inpAmount').value = '';
    $('inpCategory').value = '';
    $('inpNote').value = '';
    modal.showModal();
  }

  function abrirModalEdicion(id){
    const it = data.find(x=>x.id===id);
    if(!it) return;

    editingId = id;

    $('modalTitle').textContent = 'Editar movimiento';
    $('inpDate').value = it.date;
    $('inpType').value = it.type;
    $('inpAmount').value = it.amount;
    $('inpCategory').value = it.category || '';
    $('inpNote').value = it.note || '';

    modal.showModal();
  }


  function guardar(ev){
    ev.preventDefault();

    const date = $('inpDate').value;
    const type = $('inpType').value;
    const amount = parseFloat($('inpAmount').value);
    const category = $('inpCategory').value;
    const note = $('inpNote').value.trim();

    if(!date || !type || !isFinite(amount)){
      alert('Complet√° fecha, tipo y monto v√°lido.');
      return;
    }

    if(editingId){
      const idx = data.findIndex(x=>x.id===editingId);
      if(idx>-1){
        data[idx] = {...data[idx], date, type, amount, category, note };
      }
    } else {
      data.push({
        id: crypto.randomUUID(),
        date, type, amount, category, note
      });
    }

    save(data);
    modal.close();
    refresh();
  }



  /* ==========================
        ELIMINAR
  =========================== */
  function eliminar(id){
    if(!confirm('¬øBorrar este movimiento?')) return;
    data = data.filter(x=>x.id!==id);
    save(data);
    refresh();
  }



  /* ==========================
        EXPORTACI√ìN
     (xlsx + PDF corregido)
  =========================== */
  async function exportar(){
    if(!data.length){
      alert('No hay movimientos.');
      return;
    }

    const rows = [["Fecha","Tipo","Monto","Categor√≠a","Nota"]];
    aplicarFiltros().forEach(x=>{
      rows.push([
        x.date,
        x.type,
        String(x.amount),
        x.category || '-',
        x.note || '-'
      ]);
    });

    const formato = prompt('xlsx o pdf?','xlsx');
    if(!formato) return;

    if(formato === 'xlsx'){
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, 'Finanzas');
      XLSX.writeFile(wb, 'CisneBlanco_Finanzas.xlsx');
    }

    else if(formato === 'pdf'){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      let y = 20;
      rows.forEach(r=>{
        doc.text(r.join(' | '), 10, y);
        y += 7;
        if(y > 280){
          doc.addPage();
          y = 20;
        }
      });

      doc.save('CisneBlanco_Finanzas.pdf');
    }
  }



  /* ==========================
        UTILIDADES
  =========================== */
  function formato(n){
    return new Intl.NumberFormat('es-AR',{
      style:'currency', currency:'ARS'
    }).format(n);
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m=>({
      '&':'&amp;', '<':'&lt;', '>':'&gt;',
      '"':'&quot;', "'":'&#39;'
    }[m]));
  }



  /* ==========================
        REFRESH GENERAL
  =========================== */
  function refresh(){
    const list = aplicarFiltros();
    renderTotales(list);
    renderLista(list);
    renderCharts(list);
  }



  /* ==========================
        EVENTOS
  =========================== */
  $('btnAdd').onclick      = abrirModalAlta;
  $('btnSave').onclick     = guardar;
  $('btnExport').onclick   = exportar;

  filtroCatEl.onchange   = ()=>{ filtros.categoria = filtroCatEl.value; refresh(); };
  filtroDesdeEl.onchange = ()=>{ filtros.desde     = filtroDesdeEl.value; refresh(); };
  filtroHastaEl.onchange = ()=>{ filtros.hasta     = filtroHastaEl.value; refresh(); };

  $('btnLimpiarFiltros').onclick = ()=>{
    filtros = { categoria:'', desde:'', hasta:'' };
    filtroCatEl.value = '';
    filtroDesdeEl.value = '';
    filtroHastaEl.value = '';
    refresh();
  };

  modoGraficoEl.onchange = refresh;



  /* ==========================
        MODAL TRADING
  =========================== */
  const modalTrade = $('modalTrade');

  $('btnAddTrade').onclick = ()=>{
    $('tradeDate').value   = toISO(new Date());
    $('tradeTicker').value = '';
    $('tradeTime').value   = '';
    $('tradeType').value   = 'buy';
    $('tradeTicket').value = '';
    $('tradeEntry').value  = '';
    $('tradeSL').value     = '';
    $('tradeTP').value     = '';
    $('tradeProfit').value = '';
    modalTrade.showModal();
  };

  $('btnSaveTrade').onclick = ev=>{
    ev.preventDefault();

    const date   = $('tradeDate').value;
    const profit = parseFloat($('tradeProfit').value);

    if(!date || !isFinite(profit)){
      alert("Complet√° fecha y profit v√°lido.");
      return;
    }

    data.push({
      id: crypto.randomUUID(),
      date,
      type: profit >= 0 ? "ingreso" : "egreso",
      amount: Math.abs(profit),
      category: "Trades",
      note: `Trade ${$('tradeTicker').value} (${ $('tradeType').value.toUpperCase() }) ‚Äî Ticket ${$('tradeTicket').value} ‚Äî Entry ${$('tradeEntry').value} ‚Äî SL ${$('tradeSL').value} ‚Äî TP ${$('tradeTP').value}`
    });

    save(data);
    modalTrade.close();
    refresh();
  };


  /* ==========================
        CARGA INICIAL
  =========================== */
  refresh();


}); // FIN DOMContentLoaded
</script>




<!-- ========= Librer√≠as externas ========= -->
<script src="../assets/js/theme.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- jsPDF CORRECTO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  [data-theme="navy-ice"] #chartTorta,
  [data-theme="navy-ice"] #chartBarras {
    filter: brightness(1.35) contrast(1.15);
  }
</style>

</body>
</html>
