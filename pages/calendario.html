<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cisne Blanco ‚Äî Calendario</title>
  <link rel="icon" href="../assets/favicon.ico" />
  <link rel="stylesheet" href="../assets/css/main.css?v=1401.1" />
</head>

<body class="transition-theme">

<header class="topbar">
  <div class="topbar-inner">
    <a href="../index.html" class="brand">
      <span class="brand-dot">CB</span>
      <span class="brand-title">Cisne Blanco ‚Äî Maqueta Base</span>
    </a>

    <nav class="tabs">
      <a href="../index.html">Inicio</a>
      <a class="active" href="./calendario.html">Calendario</a>
      <a href="./habitos.html">H√°bitos</a>
      <a href="./salud.html">Salud</a>
      <a href="./familia.html">Familia</a>
      <a href="./social.html">Social</a>
      <a href="./finanzas.html">Finanzas</a>
    </nav>

    <button id="themeToggle" class="theme-pill">
      Tema: <span id="themeLabel">auto</span>
    </button>
  </div>
</header>

<main style="max-width:1100px;margin:1.25rem auto;padding:0 1rem;">
  <!-- Barra superior -->
  <section class="card" style="padding:1rem;display:flex;gap:.75rem;align-items:center;justify-content:space-between;">
    <div style="display:flex;align-items:center;gap:.5rem;">
      <button id="btnPrev" class="btn">‚Üê</button>
      <button id="btnNext" class="btn">‚Üí</button>
      <button id="btnToday" class="btn">Hoy</button>
      <button id="btnExternalLink" class="btn" data-link="">üîó Link a...</button>
      <button id="btnSetLink" class="btn btn-sm">Editar link</button>
      <button id="btnExport" class="btn btn-sm">Descargar eventos</button>
    </div>
    <h1 id="labelMonth" style="margin:0;font-size:1.25rem;"></h1>
    <div>
      <button id="btnAdd" class="btn btn-primary">+ Evento</button>
    </div>
  </section>

  <!-- Grilla del mes -->
  <section class="surface" style="margin-top:1rem;padding:1rem;">
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:.5rem;margin-bottom:.5rem;">
      <div class="muted">Lun</div><div class="muted">Mar</div><div class="muted">Mi√©</div>
      <div class="muted">Jue</div><div class="muted">Vie</div><div class="muted">S√°b</div><div class="muted">Dom</div>
    </div>
    <div id="grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:.5rem;"></div>
  </section>

  <!-- Panel de eventos del d√≠a -->
  <section class="day-events" style="margin-top:1rem;padding:1rem;">
    <h2 style="margin-top:0;">Eventos del d√≠a</h2>
    <div id="listDay"></div>
    <div style="margin-top:1rem;display:flex;gap:.5rem;">
      <button id="btnClearDay" class="btn">Borrar todos</button>
    </div>
  </section>
</main>

<!-- Toggle simple (coherente con theme.js) -->
<script>
(function(){
  const root = document.documentElement;
  const KEY = "theme"; // 'auto' | 'navy-ice'
  const btn = document.getElementById('themeToggle');
  const lab = document.getElementById('themeLabel');
  function apply(val){
    if (val === 'navy-ice') root.setAttribute('data-theme','navy-ice');
    else root.removeAttribute('data-theme');
    if (lab) lab.textContent = (val || 'auto');
  }
  const saved = localStorage.getItem(KEY) || 'auto';
  apply(saved);
  if (btn) btn.onclick = () => {
    const next = (localStorage.getItem(KEY) === 'navy-ice') ? 'auto' : 'navy-ice';
    localStorage.setItem(KEY, next);
    apply(next);
  };
})();
</script>

<!-- Calendario -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const pad = n => String(n).padStart(2,'0');
  const toKey = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const $ = id => document.getElementById(id);
  const label = $("labelMonth");
  const grid = $("grid");
  const modal = $("modal");
  const modalTitle = $("modalTitle");
  const inpDate = $("inpDate");
  const inpTime = $("inpTime");
  const inpTitle = $("inpTitle");
  const inpTag = $("inpTag");
  const inpNotes = $("inpNotes");
  const listDay = $("listDay");
  const btnPrev = $("btnPrev");
  const btnNext = $("btnNext");
  const btnToday = $("btnToday");
  const btnAdd = $("btnAdd");
  const btnSave = $("btnSave");
  const btnClearDay = $("btnClearDay");
  const required = [label, grid, listDay, btnPrev, btnNext, btnToday, btnAdd, btnSave, btnClearDay];
  if (required.some(n => !n)) { console.warn("[calendar] Falta alg√∫n nodo requerido; init abortado"); return; }

  const DB_KEY = "cb_calendar_events_v1";
  const load = () => JSON.parse(localStorage.getItem(DB_KEY) || "{}");
  const save = data => localStorage.setItem(DB_KEY, JSON.stringify(data));
  let state = { cursor: new Date(), selected: new Date(), editing: null };

  function tagColor(tag) {
    switch(tag) {
      case 'Trabajo': return '#1f2937';
      case 'Familia': return '#2563eb';
      case 'Salud':   return '#10b981';
      case 'Social':  return '#f59e0b';
      case 'Trading': return '#ef4444';
      default:        return '#9ca3af';
    }
  }

  function render(){
    const y = state.cursor.getFullYear();
    const m = state.cursor.getMonth();
    const first = new Date(y, m, 1);
    const start = new Date(first);
    const dow = (first.getDay()+6)%7;
    start.setDate(first.getDate()-dow);
    const monthName = state.cursor.toLocaleString('es-AR', { month:'long' });
    label.textContent = monthName.charAt(0).toUpperCase()+monthName.slice(1) + " " + y;
    grid.innerHTML = "";
    const data = load();
    for (let i=0; i<42; i++) {
      const d = new Date(start); d.setDate(start.getDate()+i);
      const isCurrent = d.getMonth() === m;
      const isToday   = toKey(d) === toKey(new Date());
      const dayKey    = toKey(d);
      const events    = data[dayKey] || [];
      const cell = document.createElement("button");
      cell.className = "day-cell card p-2 text-left";
      if (!isCurrent) cell.classList.add("dimmed-day");
      cell.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="text-sm font-semibold">${d.getDate()}</span>
          ${isToday ? '<span class="text-xs px-1.5 py-0.5 rounded bg-black text-white">hoy</span>' : ''}
        </div>
        <div class="mt-2 space-y-1 text-xs">
          ${events.slice(0,3).map(e => `
            <div class="flex items-center gap-2">
              <span style="display:inline-block;width:8px;height:8px;border-radius:9999px;background:${tagColor(e.tag)}"></span>
              <span class="truncate">${e.time ? e.time+' ‚Äî ' : ''}${e.title}</span>
            </div>
          `).join('')}
          ${events.length>3 ? '<div class="muted">+'+(events.length-3)+' m√°s</div>' : ''}
        </div>
      `;
      cell.addEventListener("click", () => { state.selected = d; renderDay(); });
      grid.appendChild(cell);
    }
    renderDay();
  }

  function renderDay(){
    const data = load();
    const key = toKey(state.selected);
    const events = data[key] || [];
    listDay.innerHTML = events.length ? '' : '<div class="muted">No hay eventos para este d√≠a.</div>';
    events.forEach((e, idx) => {
      const item = document.createElement("div");
      item.className = "card p-3 flex items-start justify-between";
      item.innerHTML = `
        <div>
          <div class="text-sm font-semibold">${e.time ? e.time+' ‚Äî ' : ''}${e.title}</div>
          <div class="text-xs muted">${e.tag || 'Sin etiqueta'}</div>
          ${e.notes ? `<div class="mt-1 text-xs muted">${e.notes}</div>` : ''}
        </div>
        <div class="action-row flex gap-2">
          <button class="btn btn-sm" data-action="edit">Editar</button>
          <button class="btn btn-sm" data-action="delete">Borrar</button>
        </div>
      `;
      item.querySelector('[data-action="edit"]').addEventListener('click', () => editEvent(key, idx));
      item.querySelector('[data-action="delete"]').addEventListener('click', () => removeEvent(key, idx));
      listDay.appendChild(item);
    });
  }

  function removeEvent(key, idx){
    const data = load();
    (data[key] = data[key] || []).splice(idx,1);
    save(data);
    render();
  }

  function editEvent(key, idx){
    const data = load();
    const ev = (data[key]||[])[idx];
    if (!ev) return;
    state.editing = { key, idx };
    const modalTitle = document.getElementById('modalTitle');
    const inpDate = document.getElementById('inpDate');
    const inpTime = document.getElementById('inpTime');
    const inpTitle = document.getElementById('inpTitle');
    const inpTag = document.getElementById('inpTag');
    const inpNotes = document.getElementById('inpNotes');
    const btnSave = document.getElementById('btnSave');
    if (modalTitle) modalTitle.textContent = "Editar evento";
    if (inpDate)  inpDate.value  = key;
    if (inpTime)  inpTime.value  = ev.time || "";
    if (inpTag)   inpTag.value   = ev.tag || "";
    if (inpTitle) inpTitle.value = ev.title || "";
    if (inpNotes) inpNotes.value = ev.notes || "";
    const modal = document.getElementById('modal');
    if (modal && modal.showModal) modal.showModal();
    if (btnSave) btnSave.textContent = "Actualizar";
  }

  // listeners
  btnPrev.onclick  = () => { state.cursor.setMonth(state.cursor.getMonth()-1); render(); };
  btnNext.onclick  = () => { state.cursor.setMonth(state.cursor.getMonth()+1); render(); };
  btnToday.onclick = () => { state.cursor = new Date(); state.selected = new Date(); render(); };
  btnAdd.onclick = () => {
    state.editing = null;
    modalTitle.textContent = "Nuevo evento";
    btnSave.textContent = "Guardar";
    inpDate.value  = toKey(state.selected);
    inpTime.value  = "";
    inpTitle.value = "";
    inpTag.value   = "";
    inpNotes.value = "";
    if (modal?.showModal) modal.showModal();
  };

  btnSave.onclick = (evClick) => {
    evClick.preventDefault();
    const date  = inpDate?.value;
    const time  = inpTime?.value;
    const title = (inpTitle?.value || "").trim();
    const tag   = inpTag?.value;
    const notes = (inpNotes?.value || "").trim();
    if (!date || !title) { alert("Complet√° fecha y t√≠tulo."); return; }
    const data = load();
    if (state.editing) {
      const { key, idx } = state.editing;
      (data[key] = data[key] || []).splice(idx,1);
      (data[date] = data[date] || []).push({ time, title, tag, notes });
      state.selected = new Date(date);
      state.editing = null;
    } else {
      (data[date] = data[date] || []).push({ time, title, tag, notes });
      state.selected = new Date(date);
    }
    save(data);
    if (modal?.close) modal.close();
    render();
  };

  btnClearDay.onclick = () => {
    const key = toKey(state.selected);
    const data = load();
    if (!data[key]?.length) return;
    if (confirm("¬øBorrar todos los eventos de este d√≠a?")) {
      delete data[key];
      save(data);
      render();
    }
  };

  // === RENDER INICIAL ===
  render();

  // === v1.6: bot√≥n ‚ÄúLink a‚Ä¶‚Äù editable desde interfaz ===
  const externalLinkBtn = document.getElementById("btnExternalLink");
  const btnSetLink = document.getElementById("btnSetLink");

  // Cargar link guardado (si existe)
  const savedLink = localStorage.getItem("cb_custom_link");
  if (externalLinkBtn && savedLink) {
    externalLinkBtn.setAttribute("data-link", savedLink);
  }

  // Mostrar favicon y activar clic
  function updateFaviconAndClick() {
    const link = externalLinkBtn?.getAttribute("data-link")?.trim();
    if (!link) return;
    try {
      const domain = new URL(link).hostname;
      const favicon = document.createElement("img");
      favicon.src = `https://www.google.com/s2/favicons?domain=${domain}`;
      favicon.alt = "icon";
      favicon.style.width = "16px";
      favicon.style.height = "16px";
      favicon.style.marginRight = "6px";
      favicon.style.verticalAlign = "middle";
      externalLinkBtn.innerHTML = "üîó Link a...";
      externalLinkBtn.prepend(favicon);
      externalLinkBtn.onclick = () => window.open(link, "_blank");
    } catch (err) {
      console.warn("[CB] Error cargando favicon din√°mico:", err);
    }
  }

  if (externalLinkBtn) updateFaviconAndClick();

  // Editar link desde interfaz
  if (btnSetLink) {
    btnSetLink.addEventListener("click", () => {
      const current = localStorage.getItem("cb_custom_link") || "";
      const nuevo = prompt("Ingres√° el enlace que quieras usar:", current);
      if (!nuevo) return;
      try {
        const test = new URL(nuevo);
        localStorage.setItem("cb_custom_link", test.href);
        externalLinkBtn.setAttribute("data-link", test.href);
        updateFaviconAndClick();
        alert("‚úÖ Enlace actualizado correctamente.");
      } catch {
        alert("‚ö†Ô∏è El enlace ingresado no es v√°lido.");
      }
    });
  }
// === v1.8: Exportar eventos con selector visual ===
const btnExport = document.getElementById("btnExport");
if (btnExport) {
  btnExport.addEventListener("click", async () => {
    const data = JSON.parse(localStorage.getItem("cb_calendar_events_v1") || "{}");
    if (!Object.keys(data).length) {
      alert("‚ö†Ô∏è No hay eventos para exportar.");
      return;
    }

    // Crear tabla de datos
    const rows = [["Fecha", "Hora", "T√≠tulo", "Etiqueta", "Notas"]];
    for (const [fecha, eventos] of Object.entries(data)) {
      for (const e of eventos) {
        rows.push([fecha, e.time || "-", e.title || "-", e.tag || "-", e.notes || "-"]);
      }
    }

    // Crear di√°logo de selecci√≥n
    const modal = document.createElement("dialog");
    modal.innerHTML = `
      <form method="dialog" style="padding:1rem;min-width:250px;">
        <h3 style="margin-top:0;">Eleg√≠ formato de exportaci√≥n</h3>
        <div style="display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem;">
          <button value="xlsx" class="btn btn-primary">üíæ Excel (.xlsx)</button>
          <button value="docx" class="btn">üìÑ Word (.docx)</button>
          <button value="cancel" class="btn btn-sm" style="margin-top:.5rem;">Cancelar</button>
        </div>
      </form>
    `;
    document.body.appendChild(modal);
    modal.showModal();

    modal.addEventListener("close", async () => {
      const formato = modal.returnValue;
      modal.remove();
      if (!formato || formato === "cancel") return;

      if (formato === "xlsx") {
        // Generar archivo Excel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, "Eventos");
        XLSX.writeFile(wb, "CisneBlanco_Calendario.xlsx");
      } else if (formato === "docx") {
        // Generar archivo Word
        const doc = new window.docx.Document({
          sections: [{
            properties: {},
            children: [
              new window.docx.Paragraph({
                text: "Cisne Blanco ‚Äî Calendario de Eventos",
                heading: window.docx.HeadingLevel.HEADING_1,
              }),
              new window.docx.Paragraph({
                text: `Exportado el ${new Date().toLocaleString("es-AR")}`,
                spacing: { after: 200 },
              }),
              new window.docx.Table({
                rows: rows.map((r, i) =>
                  new window.docx.TableRow({
                    children: r.map(cell =>
                      new window.docx.TableCell({
                        children: [new window.docx.Paragraph(cell.toString())],
                        shading: i === 0 ? { fill: "DCE6F1" } : undefined,
                      })
                    ),
                  })
                ),
              }),
            ],
          }],
        });
        const blob = await window.docx.Packer.toBlob(doc);
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "CisneBlanco_Calendario.docx";
        link.click();
      }
    });
  });
}

</script>

<!-- === Modal calendario (est√°ndar) === -->
<dialog id="modal" class="card" style="padding:0;">
  <form method="dialog" style="padding:1rem 1rem 0 1rem;">
    <h3 id="modalTitle" style="margin:0 0 .75rem 0;">Nuevo evento</h3>

    <div class="modal-grid">
      <div>
        <label class="muted" for="inpDate">Fecha</label>
        <input id="inpDate" type="date" class="input">
      </div>
      <div>
        <label class="muted" for="inpTime">Hora</label>
        <input id="inpTime" type="time" class="input">
      </div>

      <div style="grid-column:1/-1;">
        <label class="muted" for="inpTitle">T√≠tulo</label>
        <input id="inpTitle" type="text" class="input" placeholder="Ej: Reuni√≥n">
      </div>

      <div>
        <label class="muted" for="inpTag">Etiqueta</label>
        <select id="inpTag" class="input">
          <option value="">Sin etiqueta</option>
          <option>Trabajo</option>
          <option>Familia</option>
          <option>Salud</option>
          <option>Social</option>
          <option>Trading</option>
        </select>
      </div>

      <div style="grid-column:1/-1;">
        <label class="muted" for="inpNotes">Notas</label>
        <textarea id="inpNotes" rows="4" class="input" placeholder="Notas adicionales..."></textarea>
      </div>
    </div>

    <div class="modal-actions">
      <button id="btnSave" class="btn btn-primary">Guardar</button>
      <button value="cancel" class="btn">Cerrar</button>
    </div>
  </form>
</dialog>

<script src="../assets/js/theme.js"></script>
<!-- Librer√≠as para exportaci√≥n -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx@8.0.0/build/index.min.js"></script>
</body>
</html>
